<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PicoCode - Local Codebase Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="container">
<!-- Confirmation Modal -->
      <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmModalLabel">Confirm action</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirmOkBtn">OK</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dependencies Modal -->
      <div class="modal fade" id="dependenciesModal" tabindex="-1" aria-labelledby="dependenciesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="dependenciesModalLabel">Project Dependencies</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="dependenciesModalBody">
              <!-- Content filled by JS -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <!-- Toast container -->
    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;"></div>
      <header class="mb-4 d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">PicoCode â€” Local Codebase Assistant</h1>
          <p class="text-muted small mb-0">Project-based RAG for local codebases. Chat with your code using AI.</p>
        </div>
        <div class="config-section">
          <p class="mb-1"><strong>Embedding:</strong> {{ config.get("embedding_model") or "not set" }}</p>
          <p class="mb-0"><strong>Coding:</strong> {{ config.get("coding_model") or "not set" }}</p>
        </div>
        <div class="config-section">
          <form action="/index" method="post" class="mt-2">
            <button class="btn btn-primary btn-sm" type="submit">Index Configured Project</button>
          </form>
        </div>
      </header>

    <div class="row g-4">
      <div class="col-lg-4">
          <!-- Dependencies Card -->
          <div class="card mt-3" id="dependenciesCard" style="display:none;">
            <div class="card-body">
              <h5 class="card-title">Dependencies</h5>
              <div id="dependenciesContent"></div>
            </div>
          </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title toggle-section" style="cursor: pointer;" data-section="addProjectSection">
              Add New Project <span id="addProjectToggle">â–¼</span>
            </h5>
            <div id="addProjectSection">
              <div class="mb-2">
                <label for="new_project_path" class="form-label">Project Path <em>(absolute path)</em></label>
                <input type="text" id="new_project_path" class="form-control form-control-sm" placeholder="/path/to/your/project">
              </div>
              <div class="mb-2">
                <label for="new_project_name" class="form-label">Project Name (optional)</label>
                <input type="text" id="new_project_name" class="form-control form-control-sm" placeholder="My Project">
              </div>
              <button id="createProjectBtn" class="btn btn-success w-100" type="button">Create & Index another Project</button>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Projects</h5>
<ul class="list-group list-group-flush" id="projectsList"></ul>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Query Settings</h5>
            <div class="mb-2">
              <label for="project_id" class="form-label">Project</label>
              <select id="project_id" class="form-select form-select-sm">
                {% for p in projects %}
                  <option value="{{ p.id }}">{{ p.name or p.path.split('/')[-1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label for="top_k" class="form-label">RAG top_k</label>
              <input type="number" id="top_k" class="form-control form-control-sm" value="5" min="1" max="20">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="use_rag" checked>
              <label class="form-check-label" for="use_rag">Use RAG (semantic search)</label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Chat</h5>
            <div id="chatWindow" class="chat-window">
              <div class="empty-state">Start a conversation by typing a message below</div>
            </div>
            <div class="mt-3">
              <textarea id="userPrompt" class="form-control" rows="3" placeholder="Ask a question about your codebase..."></textarea>
              <div class="controls-area mt-2">
<button id="sendBtn" class="btn btn-primary">Send</button>
                  <button id="clearBtn" class="btn btn-outline-secondary">Clear History</button>
                  <small class="text-muted ms-2" style="font-size:0.85rem;">Ctrl+Enter to send, Esc to clear, Ctrl+K to focus</small>
                <div id="loadingIndicator" style="display:none;" class="spinner-small"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates for dynamic UI components -->
  <template id="chat-message-template">
    <div class="msg">
      <div class="card">
        <div class="card-body">
          <div class="msg-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong class="msg-author"></strong>
            <button class="btn btn-sm btn-outline-danger delete-message-btn" style="padding: 2px 8px; font-size: 12px;">&times;</button>
          </div>
          <div class="msg-content"></div>
          <div class="context-list-container" style="display:none;">
            <div class="mt-3"><strong>Files Used:</strong></div>
            <div class="context-list"></div>
          </div>
          <div class="meta mt-2"></div>
        </div>
      </div>
    </div>
  </template>

  <template id="project-item-template">
    <li class="list-group-item d-flex justify-content-between align-items-start project-item" data-project-id="${id}">
      <div class="flex-grow-1">
        <div class="fw-bold text-black">${name}</div>
        <small class="text-muted">${path}</small><br>
        <small class="text-muted">
          Status: <span class="badge bg-${statusClass}" data-status="${status}">${status}</span>
        </small>
        <br>
        <small class="text-muted indexing-info" style="display:none;">
          Indexed: <span class="file-count">0</span>/<span class="total-files">0</span> files | <span class="embedding-count">0</span> chunks
          <div class="progress mt-1" style="height:20px;">
            <div class="progress-bar bg-success" role="progressbar" style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </small>
      </div>
<div class="d-flex gap-1">
          <button type="button" class="btn btn-sm btn-outline-success continue-index-btn" data-project-id="${id}" title="Continue indexing (incremental)">+</button>
          <button type="button" class="btn btn-sm btn-outline-primary reindex-project-btn" data-project-id="${id}" title="Re-index project (full)">âŸ³</button>
          <button type="button" class="btn btn-sm btn-outline-danger delete-project-btn" data-project-id="${id}" title="Delete project">Ã—</button>
          <button type="button" class="btn btn-sm btn-outline-info view-deps-btn" data-project-id="${id}" title="View direct dependencies">ðŸ“¦</button>
            <button type="button" class="btn btn-sm btn-outline-secondary view-all-deps-btn" data-project-id="${id}" title="View all dependencies (including transitive)">ðŸ§©</button>
        </div>
    </li>
  </template>
  <template id="toast-template">
    <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"></div>
        <button class="btn btn-sm btn-light ms-2 retry-btn" style="display:none;">Retry</button>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </template>

  <script src="/static/js/main.js"></script>
</body>
</html>
